function appViewModel(){var k=this;var b,d,e;var h=[];var j=[];this.grouponDeals=ko.observableArray([]);this.filteredList=ko.observableArray([]);this.mapMarkers=ko.observableArray([]);this.dealStatus=ko.observable("Searching for deals nearby...");this.searchStatus=ko.observable();this.searchLocation=ko.observable("Pittsburgh");this.loadImg=ko.observable();this.numDeals=ko.computed(function(){return k.filteredList().length});this.toggleSymbol=ko.observable("hide");this.currentLat=ko.observable(40.440624);this.currentLng=ko.observable(-79.995888);this.goToMarker=function(m){var n=m.dealName;for(var l in k.mapMarkers()){if(n===k.mapMarkers()[l].marker.title){b.panTo(k.mapMarkers()[l].marker.position);b.setZoom(14);e.setContent(k.mapMarkers()[l].content);e.open(b,k.mapMarkers()[l].marker);b.panBy(0,-150);k.mobileShow(false);k.searchStatus("")}}};this.processLocationSearch=function(){k.searchStatus("");k.searchStatus("Searching...");var p=$("#autocomplete").val();var n,l,q;for(var o=0;o<171;o++){var m=h.divisions[o].name;if(p==m){n=h.divisions[o].id;k.currentLat(h.divisions[o].lat);k.currentLng(h.divisions[o].lng)}}if(!n){return k.searchStatus("Not a valid location, try again.")}else{k.searchLocation(p);c();k.grouponDeals([]);k.filteredList([]);k.dealStatus("Loading...");k.loadImg('<img src="img/ajax-loader.gif">');f(n);b.panTo({lat:k.currentLat(),lng:k.currentLng()})}};this.filterKeyword=ko.observable("");this.filterResults=function(){var n=k.filterKeyword().toLowerCase();var o=k.grouponDeals();if(!n){return}else{k.filteredList([]);for(var m=0;m<o.length;m++){if(o[m].dealName.toLowerCase().indexOf(n)!=-1){k.mapMarkers()[m].marker.setMap(b);k.filteredList.push(o[m])}else{for(var l=0;l<o[m].dealTags.length;l++){if(o[m].dealTags[l].name.toLowerCase().indexOf(n)!=-1){k.mapMarkers()[m].marker.setMap(b);k.filteredList.push(o[m])}else{k.mapMarkers()[m].marker.setMap(null)}}k.dealStatus(k.numDeals()+" deals found for "+k.filterKeyword())}}}};this.clearFilter=function(){k.filteredList(k.grouponDeals());k.dealStatus(k.numDeals()+" food and drink deals found near "+k.searchLocation());k.filterKeyword("");for(var l=0;l<k.mapMarkers().length;l++){k.mapMarkers()[l].marker.setMap(b)}};this.listToggle=function(){if(k.toggleSymbol()==="hide"){k.toggleSymbol("show")}else{k.toggleSymbol("hide")}};this.mapRequestTimeout=setTimeout(function(){$("#map-canvas").html("We had trouble loading Google Maps. Please refresh your browser and try again.")},8000);function a(){d=new google.maps.LatLng(40.440624,-79.995888);b=new google.maps.Map(document.getElementById("map-canvas"),{center:d,zoom:12,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER,style:google.maps.ZoomControlStyle.SMALL},streetViewControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM},mapTypeControl:false,panControl:false});clearTimeout(k.mapRequestTimeout);google.maps.event.addDomListener(window,"resize",function(){var l=b.getCenter();google.maps.event.trigger(b,"resize");b.setCenter(l)});e=new google.maps.InfoWindow({maxWidth:300});f("Pittsburgh");i()}function f(m){var n="https://partner-api.groupon.com/deals.json?tsToken=US_AFF_0_203644_212556_0&filters=category:food-and-drink&limit=30&offset=0&division_id=";var l=m;$.ajax({url:n+l,dataType:"jsonp",success:function(v){console.log(v);var p=v.deals.length;for(var t=0;t<p;t++){var o=v.deals[t].options[0].redemptionLocations[0];if(v.deals[t].options[0].redemptionLocations[0]===undefined){continue}var r=v.deals[t].merchant.name;venueLat=o.lat,venueLon=o.lng,gLink=v.deals[t].dealUrl,gImg=v.deals[t].mediumImageUrl,blurb=v.deals[t].pitchHtml,address=o.streetAddress1,d=o.city,state=o.state,zip=o.postalCode,shortBlurb=v.deals[t].announcementTitle,tags=v.deals[t].tags;var u;if((v.deals[t].merchant.ratings==null)||v.deals[t].merchant.ratings[0]===undefined){u=""}else{var s=v.deals[t].merchant.ratings[0].rating;var q=s.toFixed(1);u='<img src="img/burst_tiny.png"> '+q+" <span>out of 5</span>"}k.grouponDeals.push({dealName:r,dealLat:venueLat,dealLon:venueLon,dealLink:gLink,dealImg:gImg,dealBlurb:blurb,dealAddress:address+"<br>"+d+", "+state+" "+zip,dealShortBlurb:shortBlurb,dealRating:u,dealTags:tags})}k.filteredList(k.grouponDeals());g(k.grouponDeals());k.searchStatus("");k.loadImg("")},error:function(){k.dealStatus("Oops, something went wrong, please refresh and try again.");k.loadImg("")}})}function g(l){$.each(l,function(o,r){var t=r.dealLat,q=r.dealLon,n=new google.maps.LatLng(t,q),p=r.dealName;var s='<div id="infowindow"><img src="'+r.dealImg+'"><h2>'+r.dealName+"</h2><p>"+r.dealAddress+'</p><p class="rating">'+r.dealRating+'</p><p><a href="'+r.dealLink+'" target="_blank">Click to view deal</a></p><p>'+r.dealBlurb+"</p></div>";var m=new google.maps.Marker({position:n,title:p,map:b});k.mapMarkers.push({marker:m,content:s});k.dealStatus(k.numDeals()+" food and drink deals found near "+k.searchLocation());google.maps.event.addListener(m,"click",function(){k.searchStatus("");e.setContent(s);b.setZoom(14);b.setCenter(m.position);e.open(b,m);b.panBy(0,-150)})})}function c(){$.each(k.mapMarkers(),function(l,m){m.marker.setMap(null)});k.mapMarkers([])}function i(){$.ajax({url:"https://partner-api.groupon.com/division.json",dataType:"jsonp",success:function(n){h=n;for(var l=0;l<171;l++){var m=n.divisions[l].name;j.push(m)}$("#autocomplete").autocomplete({lookup:j,showNoSuggestionNotice:true,noSuggestionNotice:"Sorry, no matching results",})},error:function(){k.dealStatus("Oops, something went wrong, please reload the page and try again.");k.loadImg("")}})}this.mobileShow=ko.observable(false);this.searchBarShow=ko.observable(true);this.mobileToggleList=function(){if(k.mobileShow()===false){k.mobileShow(true)}else{k.mobileShow(false)}};this.searchToggle=function(){if(k.searchBarShow()===true){k.searchBarShow(false)}else{k.searchBarShow(true)}};this.centerMap=function(){e.close();var l=b.getCenter();var m=new google.maps.LatLng(k.currentLat(),k.currentLng());if((m.k==l.A)&&(m.D==l.F)){k.searchStatus("Map is already centered.")}else{k.searchStatus("");b.panTo(m);b.setZoom(10)}};a()}ko.bindingHandlers.selectOnFocus={update:function(a){ko.utils.registerEventHandler(a,"focus",function(b){a.select()})}};ko.applyBindings(new appViewModel());
